<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ibm.issue.dao.UserAndIdentityMapper">
	<resultMap id="UserAndIdentity"
		type="com.ibm.issue.pojo.User">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="userId" jdbcType="VARCHAR" property="userid" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="email" jdbcType="VARCHAR" property="email" />
		<result column="password" jdbcType="VARCHAR"
			property="password" />
		<result column="signUp" jdbcType="DATE" property="signup" />
		<result column="permission" jdbcType="INTEGER"
			property="permission" />
		<result column="userState" jdbcType="CHAR" property="userstate" />
		<association property="identity"
			javaType="com.ibm.issue.pojo.Identity">
			<id column="id" property="id" jdbcType="INTEGER" />
			<result column="pid" property="pid" jdbcType="INTEGER" />
			<result column="position" property="position"
				jdbcType="VARCHAR" />
		</association>
	</resultMap>



	<resultMap id="ReportAndState"
		type="com.ibm.issue.pojo.Report">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="issueId" jdbcType="VARCHAR" property="issueid" />
		<result column="title" jdbcType="VARCHAR" property="title" />
		<result column="type" jdbcType="VARCHAR" property="type" />
		<result column="level" jdbcType="CHAR" property="level" />
		<result column="version" jdbcType="VARCHAR" property="version" />
		<result column="creator" jdbcType="VARCHAR" property="creator" />
		<result column="createDate" jdbcType="DATE"
			property="createdate" />
		<result column="modifier" jdbcType="VARCHAR"
			property="modifier" />
		<result column="state" jdbcType="INTEGER" property="state" />
		<result column="planDate" jdbcType="DATE" property="plandate" />
		<result column="endDate" jdbcType="DATE" property="enddate" />
		<association property="issuestate"
			javaType="com.ibm.issue.pojo.Issuestate">
			<id column="id" property="id" jdbcType="INTEGER" />
			<result column="sid" property="sid" jdbcType="INTEGER" />
			<result column="detail" property="detail" jdbcType="VARCHAR" />
		</association>
	</resultMap>


	<resultMap id="IssueReport"
		type="com.ibm.issue.pojo.IssueReport">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="userId" jdbcType="VARCHAR" property="userid" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="createNum" jdbcType="INTEGER" property="createNum" />
		<result column="modifiNum" jdbcType="INTEGER" property="modifiNum" />
		<result column="finishNum" jdbcType="INTEGER" property="finishNum" />
		<result column="completeRate" jdbcType="DOUBLE" property="completeRate" />
		<association property="report"
			javaType="com.ibm.issue.pojo.Identity">
			<id column="id" property="id" jdbcType="INTEGER" />
			<result column="creator" property="creator" jdbcType="VARCHAR" />
			<result column="modifier" property="modifier"
				jdbcType="VARCHAR" />
			<result column="state" property="state" jdbcType="INTEGER" />
		</association>
	</resultMap>


	<select id="test" resultMap="UserAndIdentity">
		select
		user.userId,user.name,user.email,user.password,user.signUp,user.userState,identity.position
		from user,identity
		where user.permission = identity.pid
		<if test="userid != null">
			AND userId like concat('%', #{userid}, '%')
		</if>
		<if test="name != null">
			AND name like concat('%', #{name}, '%')
		</if>

	</select>

	<select id="findUserAndIdentity" resultMap="UserAndIdentity">
		select
		user.userId,user.name,user.email,user.password,user.signUp,user.userState,identity.position
		from user,identity
		where user.permission = identity.pid
		<if test="user != null">
			<if test="user.userid != null">
				AND user.userId like concat('%', #{user.userid}, '%')
			</if>
		</if>
		<if test="user != null">
			<if test="user.name != null">
				AND user.name like concat('%', #{user.name}, '%')
			</if>
		</if>
	</select>


	<select id="findReportAndState2" resultMap="ReportAndState">
		select
		r.id,r.issueId,r.title,r.creator,r.createDate,r.modifier,i.detail,r.planDate,r.endDate
		from report r,issuestate i
		where r.state = i.sid
		<if test="issueid != null">
			AND issueId like concat('%', #{issueid}, '%')
		</if>
		<if test="state != null">
			AND state like concat('%', #{state}, '%')
		</if>
		<if test="creator != null">
			AND creator like concat('%', #{creator}, '%')
		</if>
		<if test="modifier != null">
			AND modifier like concat('%', #{modifier}, '%')
		</if>

		<if test="createStartDate != null and createEndDate == null">
			AND createdate &gt; #{createStartDate}
		</if>
		<if test="createStartDate == null and createEndDate != null">
			AND createdate &lt; #{createEndDate}
		</if>
		<if test="createStartDate != null and createEndDate != null">
			AND createdate between #{createStartDate} and
			#{createEndDate}
		</if>

		<if test="endStartDate != null and endEndDate != null">
			AND enddate
			between #{endStartDate} and #{endEndDate}
		</if>
		<if test="endStartDate != null and endEndDate == null">
			AND enddate
			&gt; #{endStartDate}
		</if>
		<if test="endStartDate = null and endEndDate != null">
			AND enddate
			&lt; #{endEndDate}
		</if>
	</select>


	<select id="findIssueReport" resultMap="IssueReport">
		SELECT
		user.userId,
		user.name,
		(SELECT COUNT(report.id) FROM report WHERE report.creator=user.userId) as createNum , 
		(SELECT COUNT(report.id) FROM report WHERE report.modifier=user.userId) as modifiNum ,
		(SELECT COUNT(report.id) FROM report WHERE report.modifier=user.userId and report.state = 3) as finishNum,
		(SELECT COUNT(report.id) FROM report WHERE report.modifier=user.userId and report.state = 3)/(SELECT COUNT(report.id) FROM report WHERE report.modifier=user.userId) as completeRate
		FROM
		user,report
		<if test="userid != null">
			WHERE user.userId=#{userid}
		</if>
		<if test="name != null">
			AND user.name=#{name}
		</if>
		GROUP BY
		user.id;
	</select>



</mapper>